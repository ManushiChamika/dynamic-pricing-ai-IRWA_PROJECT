Project code dump generated: 2025-08-27T19:36:15.1662993+05:30
RootPath: C:\Users\SASINDU\Desktop\IRWA Group Repo\dynamic-pricing-ai-IRWA_PROJECT
FileCount: 23
MaxFileSizeMB: 10


==== FILE: .vscode\launch.json ====
SizeBytes: 390
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: D7BBF1FB696CCAF2F160469714EC895CE4325D0C60B941AF2BC30C49258E7466
---- START CONTENT ----
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Streamlit: run app",
      "type": "python",
      "request": "launch",
      "module": "streamlit",
      "args": ["run", "app/streamlit_app.py", "--server.port=8501"],
      "cwd": "${workspaceFolder}",
      "console": "integratedTerminal",
      "env": { "PYTHONPATH": "${workspaceFolder}" }
    }
  ]
}

---- END CONTENT ----


==== FILE: app\_cookies.py ====
SizeBytes: 381
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 00942212EB1F4661E7F468E40C367072680B74DD8784539D5BEDA8FBF3806785
---- START CONTENT ----
# app/_cookies.py
import streamlit as st
import extra_streamlit_components as stx

COOKIE_NAME = "fp_session"

def get_cookie_manager():
    if "cookie_manager" not in st.session_state:
        # Create ONE component instance and reuse it
        st.session_state["cookie_manager"] = stx.CookieManager(key="cookie-manager")
    return st.session_state["cookie_manager"]

---- END CONTENT ----


==== FILE: app\pages\_logout.py ====
SizeBytes: 1954
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: CC8A52626AC8F3464277A6D19493A8856EEC38ABC3A13C995EC139100D3423F4
---- START CONTENT ----
# app/pages/_logout.py
import streamlit as st
from app.session_utils import ensure_session_from_cookie, cookie_mgr, clear_session_cookie
from core.auth_service import revoke_session_token

st.set_page_config(page_title="Logout â€” FluxPricer AI", page_icon="ğŸ‘‹", layout="centered")

# Restore from cookie if present
ensure_session_from_cookie("logout")

# Mount CookieManager so its JS can clear cookies on this page
cm = cookie_mgr()

st.header("Log out")
st.write("Are you sure you want to log out?")

col1, col2 = st.columns([1, 1])

with col1:
    if st.button("âœ… Yes, log out", key="logout_yes"):
        session = st.session_state.get("session")

        if session:
            # Revoke server-side (best effort)
            tok = session.get("token")
            if tok:
                try:
                    revoke_session_token(tok)
                except Exception:
                    pass

            # Prevent immediate cookie-based restore and drop in-memory session
            st.session_state.pop("session", None)
            st.session_state["_skip_cookie_restore_once"] = True

            # Clear the browser cookie (expires_at + max_age=0 + delete with exact attrs)
            clear_session_cookie()

            st.success("Youâ€™ve been logged out.")
            st.caption("Cookie cleared. Redirectingâ€¦")
            st.markdown('<meta http-equiv="refresh" content="1.2;url=/">', unsafe_allow_html=True)
        else:
            # Not logged in â†’ send user to Login with a message
            st.session_state["flash_info"] = "Please log in first."
            st.switch_page("pages/1_Login.py")

with col2:
    if st.button("âŒ Cancel", key="logout_cancel"):
        # If logged in, go home; else go to Login
        if st.session_state.get("session"):
            st.switch_page("pages/0_Home.py")
        else:
            st.switch_page("pages/1_Login.py")

---- END CONTENT ----


==== FILE: app\pages\0_Home.py ====
SizeBytes: 14297
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 34D86D00D1EDDF7E971BB72B94B890D9DFF36F0DFB025A4DE3D28426B7F457C6
---- START CONTENT ----
from app.session_utils import COOKIE_NAME, cookie_mgr, ensure_session_from_cookie
from core.auth_service import revoke_session_token
import streamlit as st, pathlib

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Page config
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
st.set_page_config(
    page_title="FluxPricer AI â€” Home",
    page_icon="ğŸ’¹",
    layout="wide",
    menu_items={
        "Get help": None,
        "Report a bug": None,
        "About": "FluxPricer AI â€” demo for coursework. Not for production use."
    },
)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Global Styles (Professional, Modern, Accessible)
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
st.markdown(
    """
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Montserrat:wght@300;400;600;700&display=swap');

  :root {
    --primary: #4f46e5;      /* Indigo 600 */
    --secondary: #7c3aed;    /* Violet 600 */
    --accent1: #a78bfa;      /* Violet 400 */
    --accent2: #e0e7ff;      /* Indigo 100 */
    --dark: #111827;         /* Gray 900 */
    --muted: #6b7280;        /* Gray 500 */
    --light: #f9fafb;        /* Slate 50 */
    --success: #16a34a;      /* Green 600 */
    --warning: #f59e0b;      /* Amber 500 */
    --danger: #ef4444;       /* Red 500 */
    --info: #0ea5e9;         /* Sky 500 */
    --card: #fff;
    --border: #e5e7eb;
    --shadow: 0 8px 24px rgba(0,0,0,0.08);
  }

  /* Base */
  html, body, [class^="block-container"] {
    font-family: 'Inter', 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
    background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%);
    color: var(--dark);
  }

  /* Container width */
  section.main > div {
    max-width: 1200px;
    margin: auto;
    padding-top: 1.5rem;
  }

  /* Hide default Streamlit header */
  header[data-testid="stHeader"] { background: transparent; }

  /* Smooth hover lift */
  .lift { transition: transform .25s ease, box-shadow .25s ease; }
  .lift:hover { transform: translateY(-4px); box-shadow: var(--shadow); }

  /* Hero */
  .hero {
    position: relative;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-radius: 24px;
    padding: 3rem 2rem;
    color: white;
    text-align: center;
    max-width: 1100px;
    margin: auto;
    box-shadow: 0 12px 40px rgba(79,70,229,0.25);
  }
  .hero h1{ font-size: 2.5rem; font-weight: 800; margin-bottom: .5rem; }
  .hero p{ font-size: 1.125rem; opacity: .9; margin: 0 auto; max-width: 800px; }

  /* Cards */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.05);
    transition: transform .25s ease, box-shadow .25s ease;
  }
  .card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
  .agent-card .icon{ font-size: 2rem; line-height: 1; color: white; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 12px; width: 52px; height: 52px; display:flex; align-items:center; justify-content:center; margin-bottom: .75rem; }
  .agent-card h4{ margin:.5rem 0; font-weight: 700; }
  .agent-card p{ margin: 0; color: var(--muted); font-size: .925rem; }

  /* Metrics */
  .metric { text-align: center; }
  .metric h3{ margin:.25rem 0 0; font-size: 1.75rem; font-weight:700; }
  .kicker{ text-transform: uppercase; letter-spacing: .12em; font-size: .75rem; color: var(--muted); margin-bottom:.25rem; }

  /* Buttons */
  .stButton>button {
    width: 100%; font-weight: 600; border-radius: 10px; border: 0; padding: .75rem 1rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #fff; box-shadow: 0 8px 24px rgba(79,70,229,0.28);
    transition: transform .2s ease, box-shadow .2s ease, opacity .2s ease;
  }
  .stButton>button:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(79,70,229,0.38); }
  .stButton>button:active { transform: translateY(0); }

  .btn-secondary>button { background: #fff; color: var(--primary); border: 2px solid var(--accent1); box-shadow: none; }
  .btn-secondary>button:hover { background: #f5f3ff; }

  .btn-danger>button { background: linear-gradient(135deg, var(--danger), #fb7185); box-shadow: 0 8px 24px rgba(239,68,68,.25); }

  /* Modal */
  .overlay { position: fixed; inset: 0; background: rgba(17,24,39,.55); z-index: 999; }
  .modal { position: fixed; inset: 50% auto auto 50%; transform: translate(-50%, -50%); z-index: 1000; width: 420px; max-width: 92vw; }
  .modal .content{ background: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 20px 50px rgba(0,0,0,.2); }

  /* Footer */
  .footer { text-align: center; color: var(--muted); border-top: 1px solid #e5e7eb; padding: 1.25rem 0 .5rem; font-size: .875rem; margin-top: 2rem; }

  /* Utility */
  .center { display:flex; align-items:center; justify-content:center; }
  .mb-0{ margin-bottom:0; } .mb-2{ margin-bottom:.5rem; } .mb-3{ margin-bottom:1rem; } .mb-4{ margin-bottom:1.25rem; }
</style>
""",
    unsafe_allow_html=True,
)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Session bootstrap
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ensure_session_from_cookie("home")

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# HERO
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
st.markdown('<div class="hero">', unsafe_allow_html=True)

logo_path = pathlib.Path("assets/logo.svg")
if logo_path.exists():
    st.markdown('<div class="center mb-2">' + logo_path.read_text() + '</div>', unsafe_allow_html=True)
else:
    st.markdown('<h1 class="center mb-0">FluxPricer AI</h1>', unsafe_allow_html=True)

# Main title
st.markdown('<h1>Real-time Dynamic Pricing for Fashion & Accessories</h1>', unsafe_allow_html=True)

# âœ… Show robot image (center + larger)
robot_path = pathlib.Path("assets/robo.png")
if robot_path.exists():
    st.image(str(robot_path), width=560)


# Subtitle
st.markdown(
    '<p style="margin-top:0.5rem; opacity:.9;">Multi-agent system delivering intelligent pricing decisions with real-time market adaptation</p>',
    unsafe_allow_html=True
)

st.markdown('</div>', unsafe_allow_html=True)


# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Agents Grid
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
st.markdown("## ğŸ¤– Our Intelligent Agent System")
st.caption("Four specialized AI agents working in harmony to optimize your pricing strategy")

c1, c2, c3, c4 = st.columns(4, gap="large")
with c1:
    st.markdown('<div class="card lift agent-card"><div class="icon">ğŸ“Š</div><h4>Market Data Collector</h4><p>Gathers and preprocesses competitor pricing, sales history, and external market signals in real time.</p></div>', unsafe_allow_html=True)
with c2:
    st.markdown('<div class="card lift agent-card"><div class="icon">ğŸ¤–</div><h4>Price Optimizer</h4><p>ML models and constrained optimization converge on ideal prices across products and regions.</p></div>', unsafe_allow_html=True)
with c3:
    st.markdown('<div class="card lift agent-card"><div class="icon">ğŸ””</div><h4>Alert Agent</h4><p>Monitors market shocks and notifies you of opportunities or risks instantly.</p></div>', unsafe_allow_html=True)
with c4:
    st.markdown('<div class="card lift agent-card"><div class="icon">ğŸ‘¤</div><h4>User Interaction</h4><p>Intuitive dashboards, clear explanations of model decisions, and safe manual overrides.</p></div>', unsafe_allow_html=True)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Primary Actions
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
st.markdown("##Get Started")
a1, a2, a3 = st.columns(3, gap="large")

if st.session_state.get("session"):
    with a1:
        st.markdown('<div class="card lift"><div class="kicker">Navigation</div>', unsafe_allow_html=True)
        if st.button("Alerts & Notifications", key="btn_alerts"):
            st.switch_page("pages/5_Alerts_and_Notifications.py")
        st.markdown('</div>', unsafe_allow_html=True)

    with a2:
        st.markdown('<div class="card lift"><div class="kicker">Account</div>', unsafe_allow_html=True)
        if st.button("Profile", key="btn_profile"):
            st.switch_page("pages/4_Profile.py")
        st.markdown('</div>', unsafe_allow_html=True)

    with a3:
        st.markdown('<div class="card lift"><div class="kicker">Session</div>', unsafe_allow_html=True)
        st.markdown('<div class="stButton btn-danger">', unsafe_allow_html=True)
        logout_clicked = st.button("Logout", key="logout_btn")
        st.markdown('</div></div>', unsafe_allow_html=True)
        if logout_clicked:
            st.session_state["confirm_logout"] = True

    # Logout confirmation modal
    if st.session_state.get("confirm_logout"):
        st.markdown('<div class="overlay"></div>', unsafe_allow_html=True)
        st.markdown('<div class="modal"><div class="content">', unsafe_allow_html=True)
        st.warning("Are you sure you want to log out?")
        mc1, mc2 = st.columns(2)
        with mc1:
            if st.button("âœ… Yes, log out", key="logout_yes", use_container_width=True):
                tok = st.session_state.get("session", {}).get("token")
                if tok:
                    try: revoke_session_token(tok)
                    except Exception: pass
                st.session_state.pop("session", None)
                st.session_state["_skip_cookie_restore_once"] = True
                st.session_state.pop("confirm_logout", None)
                st.switch_page("pages/_logout.py")
        with mc2:
            st.markdown('<div class="stButton btn-secondary">', unsafe_allow_html=True)
            if st.button("âŒ Cancel", key="logout_cancel", use_container_width=True):
                st.session_state.pop("confirm_logout", None)
            st.markdown('</div>', unsafe_allow_html=True)
        st.markdown('</div></div>', unsafe_allow_html=True)

else:
    with a1:
        st.markdown('<div class="card lift"><div class="kicker">Welcome back</div>', unsafe_allow_html=True)
        if st.button("ğŸ”‘ Login", key="btn_login"):
            st.switch_page("pages/1_Login.py")
        st.markdown('</div>', unsafe_allow_html=True)
    with a2:
        st.markdown('<div class="card lift"><div class="kicker">New here?</div>', unsafe_allow_html=True)
        st.markdown('<div class="stButton btn-secondary">', unsafe_allow_html=True)
        if st.button("âœ¨ Create Account", key="btn_register"):
            st.switch_page("pages/2_Register.py")
        st.markdown('</div></div>', unsafe_allow_html=True)
    a3.write("")

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Status Summary
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
st.divider()

s1, s2, s3 = st.columns(3, gap="large")

auth_state = "Logged in" if st.session_state.get("session") else "Guest"
status_color = "var(--success)" if st.session_state.get("session") else "var(--warning)"

with s1:
    st.markdown(f'<div class="card metric lift"><div class="kicker">Auth Status</div><h3 style="color:{status_color}">{auth_state}</h3></div>', unsafe_allow_html=True)
with s2:
    st.markdown('<div class="card metric lift"><div class="kicker">Active Agents</div><h3 style="color: var(--info)">4</h3></div>', unsafe_allow_html=True)
with s3:
    st.markdown('<div class="card metric lift"><div class="kicker">Monitoring</div><h3 style="color: var(--primary)">24/7</h3></div>', unsafe_allow_html=True)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Footer
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
st.markdown('<div class="footer">FluxPricer AI Â© â€” demo for coursework. Not for production use.</div>', unsafe_allow_html=True)

---- END CONTENT ----


==== FILE: app\pages\1_Login.py ====
SizeBytes: 3218
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 58FC3CEB0A38A6A7A1BFBCAA896DADA32D8C3A890C6826860E6814EE51658B93
---- START CONTENT ----
# app/pages/1_Login.py
# --- path bootstrap ---
import sys, pathlib
HERE = pathlib.Path(__file__).resolve()
ROOT = next(p for p in [HERE, *HERE.parents] if (p / "core").exists())
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))
# ----------------------

import streamlit as st
from datetime import datetime, timedelta, timezone

from core.auth_db import init_db
from core.auth_service import authenticate, create_persistent_session
from app.session_utils import ensure_session_from_cookie, COOKIE_NAME, cookie_mgr



# 1) FIRST Streamlit call
st.set_page_config(page_title="Login â€” FluxPricer AI", page_icon="ğŸ”", layout="centered")

# 2) Init DB and let ensure_session_from_cookie() be the ONLY place that mounts CookieManager
init_db()
ensure_session_from_cookie()  # mounts component, handles first-pass None/{} and sets session if cookie valid

# 3) If we were waiting for cookie commit from the previous submit:
if st.session_state.get("_await_cookie_commit"):
    if st.session_state.get("session"):
        # cookie was read & validated by ensure_session_from_cookie()
        st.session_state.pop("_await_cookie_commit", None)
        st.session_state["_post_login_redirect_ready"] = True
        st.rerun()
    else:
        st.info("Still finalizing sign-inâ€¦")
        st.stop()

# 4) Redirects
if st.session_state.get("_post_login_redirect_ready"):
    st.session_state.pop("_post_login_redirect_ready", None)
    st.switch_page("pages/dashboard.py")

if st.session_state.get("session"):
    st.switch_page("pages/dashboard.py")


# 5) UI
st.title("ğŸ” Login")
with st.form("login_form", clear_on_submit=False):
    email = st.text_input("Email", placeholder="you@example.com")
    password = st.text_input("Password", type="password")
    submitted = st.form_submit_button("Login")

# 6) Handle submit
if submitted:
    email_norm = (email or "").strip().lower()
    pw = (password or "").strip()

    if not email_norm or not pw:
        st.error("Email and password are required.")
    else:
        try:
            # 2FA removed: only email & password
            session = authenticate(email=email_norm, password=pw)
            st.session_state["session"] = session

            # Create server-side token
            token, _ = create_persistent_session(session["user_id"])

            # Set the cookie using the ONE CookieManager instance
            cm = cookie_mgr()  # singleton
            expires_at = datetime.now(timezone.utc) + timedelta(days=7)
            cm.set(
                COOKIE_NAME,
                token,
                expires_at=expires_at,   # if your stx version doesn't support expires_at, switch to expires=expires_at
                max_age=7*24*60*60,
                path="/",
                same_site="Lax",
                # secure=True,  # enable on HTTPS in prod
            )

            # Allow this render to complete so browser commits the cookie.
            st.session_state["_await_cookie_commit"] = True
            st.success("Welcome! Finalizing sign-inâ€¦")
            st.stop()
        except Exception as e:
            st.error(str(e))

---- END CONTENT ----


==== FILE: app\pages\2_Register.py ====
SizeBytes: 2012
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 9673AB7C56E66FB2A4EA807069F76DA0D5F759A82283931F0F5CFDA67AA129AE
---- START CONTENT ----
# --- path bootstrap ---
import sys, pathlib
HERE = pathlib.Path(__file__).resolve()
ROOT = next(p for p in [HERE, *HERE.parents] if (p / "core").exists())
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))
# ----------------------

import streamlit as st
from datetime import timedelta  # (not required, just here if you later add auto-login)
st.set_page_config(page_title="Register â€” FluxPricer AI", page_icon="ğŸªª", layout="centered")

from core.auth_db import init_db
from core.auth_service import RegisterIn, register_user
from app.session_utils import ensure_session_from_cookie

# Init + cookie-based session restore
init_db()
ensure_session_from_cookie()

# Already logged in? Go home.
if st.session_state.get("session"):
    st.switch_page("pages/0_Home.py")
    st.stop()

st.title("ğŸªª Create Account")
with st.form("register_form", clear_on_submit=False):
    email = st.text_input("Email", placeholder="you@example.com")
    full_name = st.text_input("Full name (optional)")
    password = st.text_input("Password (â‰¥10 chars)", type="password")
    submitted = st.form_submit_button("Register")

if submitted:
    email_norm = (email or "").strip().lower()
    full_name_norm = (full_name or "").strip() or None
    pw = (password or "").strip()

    # Quick client-side checks (server will re-validate anyway)
    if not email_norm:
        st.error("Email is required.")
    elif len(pw) < 10:
        st.error("Password must be at least 10 characters.")
    else:
        try:
            register_user(RegisterIn(
                email=email_norm,
                full_name=full_name_norm,
                password=pw,
            ))
            st.success("Account created. Please log in.")
            st.switch_page("pages/1_Login.py")
            st.stop()
        except Exception as e:
            # Pass through the nice messages from register_user (email exists, invalid email, etc.)
            st.error(str(e))

---- END CONTENT ----


==== FILE: app\pages\4_Profile.py ====
SizeBytes: 1784
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: B6769D725D2DD4545373AC17F88E48798A9E17ABDB62991BA0776B9EDE4E991F
---- START CONTENT ----
# --- path bootstrap ---
import sys, pathlib
HERE = pathlib.Path(__file__).resolve()
ROOT = next(p for p in [HERE, *HERE.parents] if (p / "core").exists())
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))
# ----------------------

import streamlit as st
st.set_page_config(page_title="Profile â€” FluxPricer AI", page_icon="ğŸ‘¤", layout="centered")

from core.auth_service import get_profile
from app.session_utils import ensure_session_from_cookie

# Restore session from cookie on refresh
ensure_session_from_cookie()

# ---- auth guard ----
session = st.session_state.get("session")
if not session:
    st.warning("Please login first.")
    st.stop()

# ---- simple CSS ----
st.markdown("""
<style>
.page-wrap {max-width: 820px; margin: 0 auto;}
.card {
  background:#111827; border:1px solid #1f2937; border-radius:16px; padding:18px;
  box-shadow: 0 4px 20px rgba(0,0,0,.25);
}
.kv {display:flex; gap:8px; align-items:center; margin:6px 0;}
.kv label {width:140px; color:#9ca3af;}
</style>
""", unsafe_allow_html=True)

# ---- load profile ----
try:
    prof = get_profile(session["user_id"])
except Exception as e:
    st.error(f"Could not load profile: {e}")
    st.stop()

st.markdown("<div class='page-wrap'>", unsafe_allow_html=True)

st.markdown(f"""
<div class="card">
  <div class="kv"><label>User ID</label><div>{prof.get("id","-")}</div></div>
  <div class="kv"><label>Email</label><div>{prof.get("email","-")}</div></div>
  <div class="kv"><label>Name</label><div>{prof.get("full_name") or "-"}</div></div>
</div>
""", unsafe_allow_html=True)

# Actions row
c1, c2 = st.columns([1, 1])

with c2:
    if st.button("Back to Home", key="btn_back_home"):
        st.switch_page("pages/0_Home.py")

---- END CONTENT ----


==== FILE: app\pages\5_Alerts_and_Notifications.py ====
SizeBytes: 3238
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: D94C0161941F9AA981BE26D9BE0345703953470B93FD5CE7C913DBDD31A01C3B
---- START CONTENT ----
# app/pages/5_Alerts_and_Notifications.py
# --- path bootstrap ---
import sys, pathlib
HERE = pathlib.Path(__file__).resolve()
ROOT = next(p for p in [HERE, *HERE.parents] if (p / "core").exists())
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))
# ----------------------

import asyncio, streamlit as st
from typing import List
st.set_page_config(page_title="Alerts â€” FluxPricer AI", page_icon="ğŸ””", layout="wide")

from core.bus import bus
from core.protocol import Topic
from core.models import AlertEvent
from core.agents.alert_notifier import AlertNotifier, Thresholds
from core.agents.market_collector import run_market_collector as _mc
from core.agents.pricing_optimizer import run_pricing_optimizer as _po
from app.session_utils import ensure_session_from_cookie

ensure_session_from_cookie()

if not st.session_state.get("session"):
    st.warning("Please login first."); st.stop()

st.title("ğŸ”” Alerts & Notifications")
with st.sidebar:
    st.header("Thresholds")
    undercut = st.slider("Competitor undercut â‰¥", 0.0, 0.20, 0.01, 0.005)
    demand = st.slider("Demand spike â‰¥", 0.0, 1.0, 0.80, 0.01)
    margin = st.slider("Min margin â‰¥", 0.0, 0.50, 0.10, 0.01)

    st.header("Channels")
    ch_ui = st.checkbox("UI stream", True)
    ch_slack = st.checkbox("Slack stub", False)
    ch_email = st.checkbox("Email stub", False)

    start_btn = st.button("Start Agents")
    stop_btn = st.button("Stop Agents")

log = st.empty()
status = st.empty()

# sinks
async def ui_sink(a: AlertEvent):
    lines: List[str] = st.session_state.setdefault("alert_lines", [])
    lines.append(f"[{a.ts:%H:%M:%S}] {a.kind} {a.sku} â€” {a.message} [{a.severity}]")
    st.session_state["alert_lines"] = lines[-200:]
    log.code("\n".join(st.session_state["alert_lines"]))

async def slack_stub(a: AlertEvent):
    print(f"[SLACK] #{'pricing-alerts'}: {a.kind} {a.sku} â€” {a.message} [{a.severity}]")

async def email_stub(a: AlertEvent):
    print(f"[EMAIL] ops@fluxpricer.ai: {a.kind} {a.sku} â€” {a.message} [{a.severity}]")

# âœ… subscribe only once per session to avoid duplicate alerts on rerun
if not st.session_state.get("_alert_ui_sink_subscribed"):
    bus.subscribe(Topic.ALERT.value, ui_sink)
    st.session_state["_alert_ui_sink_subscribed"] = True

async def start_agents():
    if st.session_state.get("agents_running"):
        return
    sinks = ([ui_sink] if ch_ui else []) + ([slack_stub] if ch_slack else []) + ([email_stub] if ch_email else [])
    notifier = AlertNotifier(Thresholds(undercut, demand, margin), sinks=sinks)
    await notifier.start()
    asyncio.create_task(_po())
    asyncio.create_task(_mc("SKU-123"))
    st.session_state["agents_running"] = True
    status.success("Agents running â€” watch alerts below.")

async def stop_agents():
    st.session_state["agents_running"] = False
    status.info("Agents stop signal sent (demo uses simple tasks).")

if start_btn:
    asyncio.get_event_loop().create_task(start_agents())
if stop_btn:
    asyncio.get_event_loop().create_task(stop_agents())

log.code("\n".join(st.session_state.get("alert_lines", [])) or "# Alerts will appear here...")

---- END CONTENT ----


==== FILE: app\pages\dashboard.py ====
SizeBytes: 5457
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 9E906059D9DA92EBBAF7F086BAE4A554A8BA06FED9E5B3A682487CB35F066DCB
---- START CONTENT ----
# app/pages/dashboard.py

import streamlit as st
import plotly.express as px
import pandas as pd
import random

# ---- 1) Set page config first ----
st.set_page_config(page_title="Dynamic Pricing Dashboard", page_icon="ğŸ“Š", layout="wide")

# ====== 2) Custom CSS for Light Blue Theme ======
st.markdown(
    """
    <style>
    .stApp { background-color: #a6bdde; color: #000000; }
    .stMetric { background-color: #7da3c3; border-radius: 10px; padding: 10px; color: #000000; }
    .css-1lcbmhc.e1fqkh3o3 { background-color: #a6bdde; color: #000000; }
    .stSidebar { background-color: #7da3c3; color: #000000; }
    .stChatMessage { background-color: #6b92b1; color: #000000; border-radius: 10px; padding: 5px; }
    .stTextInput > div > div > input { background-color: #a6bdde; color: #000000; border: 1px solid #000000; }
    </style>
    """,
    unsafe_allow_html=True
)

# ====== 3) AI Agent Simulation / Retrieval ======
def get_dynamic_pricing_data():
    products = ["A", "B", "C", "D", "E"]
    data = []
    for p in products:
        price = random.randint(100, 200)
        demand = random.randint(150, 500)
        data.append({"Product": p, "Price": price, "Demand": demand})
    return pd.DataFrame(data)

def get_demand_trend():
    return pd.DataFrame({
        "Date": pd.date_range(start="2025-01-01", periods=12, freq="M"),
        "Demand": [random.randint(200, 400) for _ in range(12)]
    })

def ai_chat_response(user_input):
    if "price" in user_input.lower():
        return "ğŸ’¡ The AI suggests adjusting prices based on demand trends to maximize profit."
    elif "demand" in user_input.lower():
        return "ğŸ“Š Current demand is rising. AI recommends monitoring seasonal patterns."
    elif "hello" in user_input.lower():
        return "ğŸ‘‹ Hello! Iâ€™m your Dynamic Pricing Assistant. Ask me about sales, demand, or prices."
    else:
        return "ğŸ¤– Sorry, I didnâ€™t understand. Try asking about **price**, **demand**, or **sales**."

# ====== 4) SESSION CHECK ======
if "session" not in st.session_state or st.session_state["session"] is None:
    st.warning("âš ï¸ You must log in first!")
    st.stop()

user_session = st.session_state["session"]
user_name = user_session.get("full_name", "User")

# ====== 5) DASHBOARD HEADER ======
st.markdown(f"<h2 style='color:#000000;'>ğŸ‘‹ Welcome back, <b>{user_name}</b></h2>", unsafe_allow_html=True)

# ====== 6) Metrics Section ======
st.subheader("ğŸ“ˆ Key Business Metrics")
df = get_dynamic_pricing_data()
col1, col2, col3 = st.columns(3)
col1.metric(label="ğŸ’° Total Sales", value=f"${df['Price'].sum() * 1000:,}", delta="+5%")
col2.metric(label="ğŸ’µ Avg. Price", value=f"${df['Price'].mean():.2f}", delta="-2%")
col3.metric(label="ğŸ“¦ Units Sold", value=f"{df['Demand'].sum():,}", delta="+8%")
st.markdown("---")

# ====== 7) Tabs for Charts & AI Chat ======
tab1, tab2 = st.tabs(["ğŸ“Š Charts", "ğŸ’¬ AI Chat Assistant"])

with tab1:
    st.subheader("ğŸ’¡ AI Prediction: Price vs Demand")
    fig = px.scatter(
        df, x="Price", y="Demand", size="Demand", color="Product",
        hover_name="Product",
        template="plotly_white",
        width=900, height=500
    )
    fig.update_layout(
        plot_bgcolor="#5896ed",
        paper_bgcolor="#5896ed",
        font_color="#000000",
        xaxis=dict(gridcolor="#a6bdde", title_font_color="#000000", tickfont_color="#000000"),
        yaxis=dict(gridcolor="#a6bdde", title_font_color="#000000", tickfont_color="#000000"),
        legend=dict(font_color="#000000")
    )
    st.plotly_chart(fig, use_container_width=True)

    st.subheader("ğŸ“ˆ AI Forecast: Demand Over Time")
    trend_df = get_demand_trend()
    fig2 = px.line(
        trend_df, x="Date", y="Demand", markers=True,
        template="plotly_white",
        width=900, height=400
    )
    fig2.update_traces(line=dict(color="#FFFFFF"))  # Line color white
    fig2.update_layout(
        plot_bgcolor="#5896ed",
        paper_bgcolor="#5896ed",
        font_color="#000000",
        xaxis=dict(gridcolor="#a6bdde", title_font_color="#000000", tickfont_color="#000000"),
        yaxis=dict(gridcolor="#a6bdde", title_font_color="#000000", tickfont_color="#000000")
    )
    st.plotly_chart(fig2, use_container_width=True)

with tab2:
    if "chat_history" not in st.session_state:
        st.session_state["chat_history"] = []

    for chat in st.session_state["chat_history"]:
        with st.chat_message(chat["role"]):
            st.markdown(chat["content"])

    if user_input := st.chat_input("Ask me about pricing, demand, or sales..."):
        st.session_state["chat_history"].append({"role": "user", "content": user_input})
        with st.chat_message("user"):
            st.markdown(user_input)

        response = ai_chat_response(user_input)
        st.session_state["chat_history"].append({"role": "assistant", "content": response})
        with st.chat_message("assistant"):
            st.markdown(response)

# ====== 8) Sidebar ======
st.sidebar.title("âš™ï¸ Menu")
st.sidebar.subheader("ğŸ‘¤ User Info")
st.sidebar.info(f"**Name:** {user_name}\n**Email:** {user_session.get('email')}")

if st.sidebar.button("ğŸšª Logout"):
    st.session_state["session"] = None
    st.success("You have been logged out. Please refresh or go back to login.")
    st.stop()

---- END CONTENT ----


==== FILE: app\session_utils.py ====
SizeBytes: 2720
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 4E6A51BABE232B65B2B1F9C221BE662FC80654EEDC0E7E6B3870D210ED9BA1D1
---- START CONTENT ----
# app/session_utils.py
import streamlit as st
import extra_streamlit_components as stx
from datetime import datetime, timedelta, timezone
from core.auth_service import validate_session_token

COOKIE_NAME = "fp_session"

# Must match how the cookie is created (your row shows Lax, secure False, no domain, path "/")
COOKIE_ATTRS = {
    "path": "/",          # required
    "samesite": "Lax",    # exactly as created
    "secure": False,      # exactly as created (True only on HTTPS prod if you used it)
    # DO NOT set "domain" for localhost (browsers ignore/forbid it)
}

def cookie_mgr() -> stx.CookieManager:
    if "_cookie_mgr" not in st.session_state:
        # one instance per Streamlit session; reuse everywhere
        st.session_state["_cookie_mgr"] = stx.CookieManager(key="cookie-manager")
    return st.session_state["_cookie_mgr"]

def set_session_cookie(token: str) -> None:
    cm = cookie_mgr()
    cm.set(COOKIE_NAME, token, key="set_session_cookie", **COOKIE_ATTRS)

def clear_session_cookie() -> None:
    """
    Clear fp_session using the same attributes it was created with.
    We do: expires_at in the past, max_age=0, and delete â€” all three,
    plus a hostOnly 'no-attrs' pass for older browsers.
    """
    cm = cookie_mgr()

    # 1) expire in the past (UTC)
    past = datetime.now(timezone.utc) - timedelta(days=1)
    try:
        cm.set(COOKIE_NAME, "", expires_at=past, key="expire_cookie", **COOKIE_ATTRS)
    except TypeError:
        cm.set(COOKIE_NAME, "", expires_at=past, key="expire_cookie")

    # 2) set max_age=0
    try:
        cm.set(COOKIE_NAME, "", max_age=0, key="maxage_cookie", **COOKIE_ATTRS)
    except TypeError:
        cm.set(COOKIE_NAME, "", max_age=0, key="maxage_cookie")

    # 3) explicit delete with matching attrs
    try:
        cm.delete(COOKIE_NAME, key="delete_cookie", **COOKIE_ATTRS)
    except TypeError:
        cm.delete(COOKIE_NAME)

    # 4) (defensive) hostOnly delete with *no attrs* â€” useful on localhost
    try:
        cm.delete(COOKIE_NAME, key="delete_cookie_hostonly")
    except Exception:
        pass

def ensure_session_from_cookie(page_key: str = "root") -> None:
    if st.session_state.pop("_skip_cookie_restore_once", False):
        return
    if st.session_state.get("session"):
        return

    cm = cookie_mgr()
    cookies = cm.get_all(key=f"get_all_{page_key}")
    if cookies is None:
        st.stop()

    token = cookies.get(COOKIE_NAME)
    if not token:
        return

    try:
        sess = validate_session_token(token)
    except Exception:
        sess = None

    if sess:
        st.session_state["session"] = sess

---- END CONTENT ----


==== FILE: app\streamlit_app.py ====
SizeBytes: 985
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 52ED5908B12D659891AE821B2DD9BB81BC631D1DEF7318F17D6FD5C54A461CEF
---- START CONTENT ----
# 1) Safe: sys.path bootstrap BEFORE any Streamlit calls
import sys, pathlib
ROOT = pathlib.Path(__file__).resolve().parents[1]
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))

# 2) First Streamlit call must be set_page_config
import streamlit as st
st.set_page_config(page_title="FluxPricer AI", page_icon="ğŸ’¹", layout="wide")

# --- Hide default "streamlit app" text in sidebar ---
st.markdown("""
    <style>
        [data-testid="stSidebarNav"] > div:first-child {
            display: none;
        }
    </style>
""", unsafe_allow_html=True)

# --- (Optional) Add your own sidebar branding ---
with st.sidebar:
    st.markdown("### FluxPricer AI")

# 3) Now it's safe to import/call helpers that render components
from app.session_utils import ensure_session_from_cookie
ensure_session_from_cookie()

# 4) Optional: init session dict and route to Home
st.session_state.setdefault("session", None)
st.switch_page("pages/0_Home.py")

---- END CONTENT ----


==== FILE: core\__init__.py ====
SizeBytes: 0
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855
---- START CONTENT ----

---- END CONTENT ----


==== FILE: core\agents\__init__.py ====
SizeBytes: 0
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855
---- START CONTENT ----

---- END CONTENT ----


==== FILE: core\agents\alert_notifier.py ====
SizeBytes: 1772
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 37BB082151661A2744686888F75C6492643A969BA7AB330F5AE1B7CA5A4DF98D
---- START CONTENT ----
from dataclasses import dataclass
from datetime import datetime
from typing import Awaitable, Callable, List, Optional
from ..bus import bus
from ..protocol import Topic
from ..models import MarketTick, PriceProposal, AlertEvent

@dataclass
class Thresholds:
    undercut_delta: float = 0.01
    demand_spike: float = 0.80
    min_margin: float = 0.10

class AlertNotifier:
    name = "alert_notifier"
    def __init__(self, thresholds: Thresholds | None = None,
                 sinks: Optional[List[Callable[[AlertEvent], Awaitable[None]]]] = None):
        self.thresholds = thresholds or Thresholds()
        self.sinks = sinks or []

    async def start(self):
        async def on_tick(tick: MarketTick):
            t = self.thresholds
            if tick.competitor_price and tick.competitor_price * (1 + t.undercut_delta) < tick.our_price:
                await self._emit("UNDERCUT", f"Competitor {tick.competitor_price} < our {tick.our_price}", "warn", tick.sku)
            if tick.demand_index >= t.demand_spike:
                await self._emit("DEMAND_SPIKE", f"Demand spike index={tick.demand_index}", "info", tick.sku)
        async def on_prop(pp: PriceProposal):
            if pp.margin < self.thresholds.min_margin:
                await self._emit("MARGIN_BREACH", f"Proposed {pp.proposed_price} margin {pp.margin:.2%}", "crit", pp.sku)

        bus.subscribe(Topic.MARKET_TICK.value, on_tick)
        bus.subscribe(Topic.PRICE_PROPOSAL.value, on_prop)

    async def _emit(self, kind, message, severity, sku):
        alert = AlertEvent(sku=sku, kind=kind, message=message, severity=severity, ts=datetime.utcnow())
        await bus.publish(Topic.ALERT.value, alert)
        for s in self.sinks: await s(alert)

---- END CONTENT ----


==== FILE: core\agents\market_collector.py ====
SizeBytes: 0
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855
---- START CONTENT ----

---- END CONTENT ----


==== FILE: core\agents\policy_guard.py ====
SizeBytes: 0
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855
---- START CONTENT ----

---- END CONTENT ----


==== FILE: core\agents\pricing_optimizer.py ====
SizeBytes: 0
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855
---- START CONTENT ----

---- END CONTENT ----


==== FILE: core\auth_db.py ====
SizeBytes: 2004
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 02DB2EEAA4E62317C62E938818F34B076E5D158A557C82BEFB7FAFF65DCB825E
---- START CONTENT ----
from pathlib import Path
from sqlalchemy import (
    create_engine, Column, Integer, String, Boolean, DateTime, func,
    UniqueConstraint, ForeignKey
)
from sqlalchemy.orm import sessionmaker, declarative_base, relationship

# DB at project root (parent of 'core')
BASE_DIR = Path(__file__).resolve().parents[1]
DB_PATH = (BASE_DIR / "auth.db").resolve()

engine = create_engine(f"sqlite:///{DB_PATH}", future=True, echo=True)
SessionLocal = sessionmaker(bind=engine, autoflush=False, autocommit=False, expire_on_commit=False)
Base = declarative_base()


class User(Base):
    __tablename__ = "users"
    __table_args__ = (UniqueConstraint("email", name="uq_users_email"),)

    id = Column(Integer, primary_key=True)
    email = Column(String(255), unique=True, nullable=False, index=True)
    full_name = Column(String(255))
    hashed_password = Column(String(512), nullable=False)
    is_active = Column(Boolean, default=True, nullable=False)
    two_factor_enabled = Column(Boolean, default=False, nullable=False)  # âœ… Fixed
    totp_secret = Column(String(64))
    created_at = Column(DateTime, server_default=func.now(), nullable=False)

    sessions = relationship("SessionToken", back_populates="user", cascade="all, delete-orphan")


class SessionToken(Base):
    __tablename__ = "session_tokens"

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    token = Column(String(255), unique=True, index=True, nullable=False)
    expires_at = Column(DateTime, nullable=False)
    revoked = Column(Boolean, default=False, nullable=False)
    created_at = Column(DateTime, server_default=func.now(), nullable=False)

    user = relationship("User", back_populates="sessions")


def init_db():
    """Create tables if they donâ€™t exist."""
    Base.metadata.create_all(bind=engine)
    print(f"Database created at {DB_PATH}")


if __name__ == "__main__":
    init_db()

---- END CONTENT ----


==== FILE: core\auth_service.py ====
SizeBytes: 3577
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: 68CE9577356FED6D545B5EBA9EBA995EC1004527D248895B71D10C4913DC228F
---- START CONTENT ----
from typing import Optional
from datetime import datetime, timedelta
import secrets

from argon2 import PasswordHasher
from email_validator import validate_email, EmailNotValidError
from pydantic import BaseModel
from sqlalchemy.exc import IntegrityError

from .auth_db import SessionLocal, User, SessionToken

ph = PasswordHasher()
SESSION_DAYS = 7  # persistent login duration


class RegisterIn(BaseModel):
    email: str
    full_name: Optional[str] = None
    password: str


def _hash(pw: str) -> str:
    return ph.hash(pw)


def _verify(pw: str, h: str) -> bool:
    try:
        ph.verify(h, pw)
        return True
    except Exception:
        return False


# ---------- Register ----------
def register_user(inp: RegisterIn) -> None:
    email_norm = (inp.email or "").strip().lower()
    pw = (inp.password or "").strip()

    # validate email
    try:
        validate_email(email_norm)
    except EmailNotValidError as e:
        raise ValueError(str(e))

    if len(pw) < 10:
        raise ValueError("Password must be at least 10 characters")

    with SessionLocal() as db:
        if db.query(User).filter(User.email == email_norm).first():
            raise ValueError("Email already registered")
        u = User(
            email=email_norm,
            full_name=(inp.full_name or "").strip() or None,
            hashed_password=_hash(pw),
        )
        db.add(u)
        db.commit()


# ---------- Login ----------
def authenticate(email: str, password: str) -> dict:
    email_norm = (email or "").strip().lower()
    pw = (password or "").strip()

    with SessionLocal() as db:
        u = db.query(User).filter(User.email == email_norm).first()
        if not u or not getattr(u, "is_active", True):
            raise ValueError("Invalid email or password")
        try:
            ph.verify(u.hashed_password, pw)
        except Exception:
            raise ValueError("Invalid email or password")

        return {"user_id": u.id, "email": u.email, "full_name": u.full_name}


# ---------- Profile ----------
def get_profile(user_id: int) -> dict:
    with SessionLocal() as db:
        u: Optional[User] = db.get(User, user_id)
        if not u:
            raise ValueError("User not found")
        return {"id": u.id, "email": u.email, "full_name": u.full_name}


# ---------- Persistent session tokens ----------
def create_persistent_session(user_id: int) -> tuple[str, datetime]:
    token = secrets.token_urlsafe(32)
    expires_at = datetime.utcnow() + timedelta(days=SESSION_DAYS)
    with SessionLocal() as db:
        db.add(SessionToken(user_id=user_id, token=token, expires_at=expires_at))
        db.commit()
    return token, expires_at


def validate_session_token(token: str) -> dict | None:
    now = datetime.utcnow()
    with SessionLocal() as db:
        row: Optional[SessionToken] = db.query(SessionToken).filter_by(token=token, revoked=False).first()
        if not row or row.expires_at <= now:
            return None

        u: Optional[User] = db.get(User, row.user_id)
        if not u or not getattr(u, "is_active", True):
            return None

        return {"user_id": u.id, "email": u.email, "full_name": u.full_name}


def revoke_session_token(token: str) -> None:
    with SessionLocal() as db:
        row: Optional[SessionToken] = db.query(SessionToken).filter_by(token=token).first()
        if row:
            row.revoked = True
            db.add(row)
            db.commit()

---- END CONTENT ----


==== FILE: prompts.md ====
SizeBytes: 0
LastWriteTime: 2025-08-26 16:07:39Z UTC
SHA256: E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855
---- START CONTENT ----

---- END CONTENT ----


==== FILE: README.md ====
SizeBytes: 33
LastWriteTime: 2025-08-26 14:44:07Z UTC
SHA256: F5F233C039C45BFDA9AF8CD60518EF5CE73C1E8E8D915C39450E6C1F9B20346D
---- START CONTENT ----
# dynamic-pricing-ai-IRWA_PROJECT
---- END CONTENT ----


==== FILE: requirements.txt ====
SizeBytes: 182
LastWriteTime: 2025-08-26 16:02:28Z UTC
SHA256: D903F29D4AF529A883F068D96CAD64633163B7A7A81649B23AD24CBB4AC588E5
---- START CONTENT ----
streamlit==1.38.0
sqlalchemy==2.0.36
argon2-cffi==23.1.0
pyotp==2.9.0
email-validator==2.2.0
pydantic==2.8.2
extra-streamlit-components==0.1.71
qrcode==7.4.2
Pillow==10.4.0

---- END CONTENT ----


==== FILE: scripts\collect_project_code.ps1 ====
SizeBytes: 5605
LastWriteTime: 2025-08-27 14:05:13Z UTC
SHA256: 58B3C7CB0EE6700702FEB2DCDA2A7214E2C3B2602E5F0F8251A935EDCA30D8DE
---- START CONTENT ----
<#
Collect project source files into a single text file with metadata.
- Excludes: __pycache__, .git, node_modules, venvs, binary files, common DB and image files
- Includes common source/text extensions and attempts to include text files without extension
- Skips files larger than MaxFileSizeMB (default 10 MB) to avoid excessive output

Usage (PowerShell):
  pwsh ./scripts/collect_project_code.ps1 -RootPath . -OutFile project_code_dump.txt

Parameters:
  -RootPath: directory to scan (default: current directory)
  -OutFile: output file path (default: ./project_code_dump.txt)
  -MaxFileSizeMB: skip files larger than this (default: 10)
  -Verbose: show progress

#>
[CmdletBinding()]
param(
    [Parameter(Position=0)]
    [string]$RootPath = ".",

    [Parameter(Position=1)]
    [string]$OutFile = "project_code_dump.txt",

    [int]$MaxFileSizeMB = 10
)

# Resolve paths
$RootPath = (Resolve-Path -Path $RootPath).ProviderPath
$OutFile = Join-Path -Path (Get-Location) -ChildPath $OutFile

# Exclude directories and file extensions
$ExcludeDirs = @('.git', '__pycache__', 'node_modules', 'venv', '.venv', 'env', 'build', 'dist', '.ipynb_checkpoints')
$AllowedExts = @('.py', '.md', '.txt', '.json', '.yaml', '.yml', '.ipynb', '.html', '.htm', '.css', '.js', '.ts', '.jsx', '.tsx', '.pyi', '.cfg', '.ini', '.toml', '.rst', '.sql', '.ps1', '.psm1')
$ExcludeExts = @('.pyc', '.pyo', '.so', '.dll', '.exe', '.png', '.jpg', '.jpeg', '.gif', '.ico', '.pdf', '.db', '.sqlite', '.class', '.jar', '.zip', '.tar', '.gz')

# Convert max size to bytes
$MaxFileSizeBytes = $MaxFileSizeMB * 1MB

function IsTextFile([string]$path) {
    try {
        $fs = [System.IO.File]::Open($path, [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read)
        try {
            $buffer = New-Object byte[] (4096)
            $bytesRead = $fs.Read($buffer, 0, $buffer.Length)
            if ($bytesRead -le 0) { return $true }
            for ($i=0; $i -lt $bytesRead; $i++) {
                if ($buffer[$i] -eq 0) { return $false }
            }
            return $true
        } finally { $fs.Close() }
    } catch {
        return $false
    }
}

function Write-Header($stream, $relPath, $fileInfo, $hash) {
    $stream.WriteLine("==== FILE: $relPath ====")
    $stream.WriteLine("SizeBytes: $($fileInfo.Length)")
    $stream.WriteLine("LastWriteTime: $($fileInfo.LastWriteTimeUtc.ToString('u')) UTC")
    $stream.WriteLine("SHA256: $hash")
    $stream.WriteLine("---- START CONTENT ----")
}

function Write-Footer($stream) {
    $stream.WriteLine("---- END CONTENT ----")
    $stream.WriteLine("`n")
}

# Gather files
Write-Verbose "Scanning $RootPath..."
$files = Get-ChildItem -Path $RootPath -Recurse -File -ErrorAction SilentlyContinue | Where-Object {
    # Exclude hidden/system mount points by path
    $full = $_.FullName
    foreach ($d in $ExcludeDirs) { if ($full -like "*\$d\*") { return $false } }

    # Exclude by extension
    $ext = $_.Extension.ToLower()
    if ($ExcludeExts -contains $ext) { return $false }

    # Allow known text extensions; also allow files without extension for inspection
    if ($ext -and -not ($AllowedExts -contains $ext)) {
        return $false
    }
    return $true
}

# Sort file list for reproducible output
$files = $files | Sort-Object FullName

# Prepare output stream (UTF8 without BOM)
$fsOut = New-Object System.IO.StreamWriter($OutFile, $false, (New-Object System.Text.UTF8Encoding($false)))
try {
    $fsOut.WriteLine("Project code dump generated: $(Get-Date -Format o)")
    $fsOut.WriteLine("RootPath: $RootPath")
    $fsOut.WriteLine("FileCount: $($files.Count)")
    $fsOut.WriteLine("MaxFileSizeMB: $MaxFileSizeMB")
    $fsOut.WriteLine("`n")

    foreach ($f in $files) {
        try {
            if ($f.Length -gt $MaxFileSizeBytes) {
                Write-Verbose "Skipping (size) $($f.FullName) [$($f.Length) bytes]"
                continue
            }

            # If extension is known text or no extension, check for binary content
            if (-not (IsTextFile $f.FullName)) {
                Write-Verbose "Skipping (binary) $($f.FullName)"
                continue
            }

            $rel = $f.FullName.Substring($RootPath.Length).TrimStart('\')
            $hash = (Get-FileHash -Path $f.FullName -Algorithm SHA256 -ErrorAction SilentlyContinue).Hash
            if (-not $hash) { $hash = '' }

            Write-Verbose "Adding: $rel"
            Write-Header $fsOut $rel $f $hash

            # Read content with safe encoding fallback
            $content = $null
            try {
                $content = Get-Content -LiteralPath $f.FullName -Raw -ErrorAction Stop -Encoding UTF8
            } catch {
                try { $content = Get-Content -LiteralPath $f.FullName -Raw -ErrorAction Stop -Encoding Default } catch { $content = "[UNREADABLE: could not decode file]" }
            }

            try {
                # Ensure content is string for writing
                if ($null -eq $content) { $content = Get-Content -LiteralPath $f.FullName -Raw -ErrorAction SilentlyContinue }
            } catch { $content = "[UNREADABLE: could not read file]" }

            $fsOut.WriteLine($content)
            Write-Footer $fsOut
        } catch {
            Write-Verbose "Error processing $($f.FullName): $_"
            continue
        }
    }
    Write-Verbose "Wrote output to $OutFile"
} finally {
    $fsOut.Close()
}

Write-Output "Done. Output: $OutFile"

---- END CONTENT ----


