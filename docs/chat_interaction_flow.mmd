sequenceDiagram
  autonumber
  participant U as User
  participant S as Streamlit Chat UI
  participant UIA as User Interaction Agent
  participant LLM as LLMClient
  participant P as LLM Provider
  participant T as "Tools: execute_sql | list_inventory | list_market_prices | list_proposals | optimize_price"
  participant ADB as "SQLite: app/data.db"
  participant MDB as "SQLite: data/market.db"
  participant PO as Price Optimizer

  U->>S: Types a message
  S->>UIA: get_response(message)
  UIA->>LLM: chat_with_tools(system prompt + tools schema)
  LLM->>P: Send messages + tools (tool_choice=auto)
  P-->>LLM: Assistant msg (content or tool_calls)

  alt Tool call required
    LLM-->>UIA: tool_calls (name + arguments)
    UIA->>T: Execute mapped Python function
    opt Database access
      T->>ADB: SELECT / list queries
      T->>MDB: SELECT / list queries
    end
    opt Optimization
      T->>PO: optimize(features, bounds, margin)
      PO-->>T: recommendation
    end
    UIA-->>LLM: Tool result (role=tool)
    LLM->>P: Continue with tool output
    P-->>LLM: Final assistant content
  else No tool needed
    Note over LLM,P: Provider returns final content directly
  end

  LLM-->>UIA: Assistant answer
  UIA-->>S: Return answer (and play sound if enabled)
  S-->>U: Render response in chat

  Note over UIA: Fallback path: if LLM unavailable/rate-limited, returns "[non-LLM assistant] ..." message